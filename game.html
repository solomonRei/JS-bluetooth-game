<!DOCTYPE html>
<html>
<head>
  <title>Test</title>
</head>
<body>
<button id="connectButton" style="display:none" >Play</button>
<button id="sendButton">Send Information</button>
<script>
  async function getDataFromBluetoothModule() {
    try {
      let device = await navigator.bluetooth.requestDevice({
        filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }]
      });

      let server = await device.gatt.connect();
      let service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
      let characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
      await characteristic.startNotifications();

      const rows = [];
      characteristic.addEventListener('characteristicvaluechanged', event => {
        let data = new Uint8Array(event.target.value.buffer);
         let stringData = String.fromCharCode(...data);

         if (rows.length === 0) {
             rows.push(stringData);
         }
         else if(rows.length === 1) {
             rows.push(stringData);
         }
         if (rows.length === 2) {
           const combinedRows = rows[0] + rows[1];
//            console.log('2-', combinedRows);
           const replacedRows = combinedRows.replace(/\r\n|\r|\n|\%/g, "");
           const splitRows = replacedRows.split(" ");

           rows.length = 0;

                   if (splitRows.length === 5) {
                     if (splitRows[0] == "1" || splitRows[0] === "0") {
                       if ((splitRows[1] >= 0 && splitRows[1] <= 1024) && (splitRows[2] >= 0 && splitRows[2] <= 1024)) {
                         console.log(splitRows);
                       }
                     }
                   }
        }
      });
    } catch (error) {
      console.error(error);
    }
  }

    async function sendDataToArduino() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }]
        });

        const server = await device.gatt.connect();
      let service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
      let characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
        console.log('Sending message');
        await characteristic.writeValue(new TextEncoder().encode("5"));
      } catch (error) {
        console.error(error);
      }
    }

    const connected = false;
      const connectButton = document.querySelector("#connectButton");
      const sendButton = document.querySelector("#sendButton");
     if (connected) {
                connectButton.addEventListener("click", async () => {
                  await getDataFromBluetoothModule()
                });

                sendButton.addEventListener("click", async () => {
                    await sendDataToArduino()
                  });
      } else {
         connectButton.addEventListener("click", async () => {
                      await getDataFromBluetoothModule()
                    });

         connectButton.style.display = "block";
      }

</script>
</body>
</html>